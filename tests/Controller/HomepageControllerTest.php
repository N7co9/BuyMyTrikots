<?php

namespace Controller;

use App\Components\Basket\Persistence\Repository\BasketRepository;
use App\Components\Homepage\Communication\Controller\HomepageController;
use App\Components\Order\Persistence\Entity\OrderEntityManager;
use App\Components\Order\Persistence\Repository\OrderRepository;
use App\Components\ThankYou\Communication\Controller\ThankYouController;
use App\Components\User\Persistence\Entity\UserEntityManager;
use App\Components\User\Persistence\Repository\UserRepository;
use App\Global\Business\Dependency\Container;
use App\Global\Business\Dependency\DependencyProvider;
use App\Global\Business\DTO\ClientDTO;
use App\Global\Business\DTO\OrderDTO;
use App\Global\Business\DTO\PlayerDTO;
use App\Global\Business\Redirect\RedirectSpy;
use App\Global\Business\Redirect\SearchEngine;
use App\Global\Persistence\SQL\SqlConnector;
use PHPUnit\Framework\TestCase;

class HomepageControllerTest extends TestCase
{
    public ThankYouController $thankYouController;
    public SqlConnector $sqlConnector;
    public UserRepository $clientRepository;
    public BasketRepository $basketRepository;
    public UserEntityManager $clientEntityManager;
    public OrderEntityManager $orderEntityManager;
    public OrderRepository $orderRepository;
    public RedirectSpy $redirectSpy;

    public function setUp(): void
    {
        $_SESSION['mail'] = 'TEST@TEST.com';

        $this->redirectSpy = new RedirectSpy();
        $this->clientRepository = new UserRepository();
        $this->sqlConnector = new SqlConnector();
        $this->basketRepository = new BasketRepository();
        $this->clientEntityManager = new UserEntityManager();
        $this->orderEntityManager = new OrderEntityManager();
        $this->orderRepository = new OrderRepository();

        $ClientDTO = new ClientDTO();
        $ClientDTO->username = 'TEST';
        $ClientDTO->email = 'TEST@TEST.com';
        $ClientDTO->password = '$2y$10$hfMft79lTEeHSDGsMf91s.iJcUTgVoIHnUQVGfxleSTXARmpr7nN6';

        $orderDTO = new OrderDTO();
        $orderDTO->email = 'TEST@TEST.com';
        $orderDTO->firstName = 'TEST-FIRST';
        $orderDTO->lastName = 'TEST-LAST';
        $orderDTO->zip = '1337';
        $orderDTO->city = 'TEST-CITY';
        $orderDTO->address = 'TEST-ADDRESS';
        $orderDTO->paymentMethod = 'TEST-PAYMENT';
        $orderDTO->delivery = 'TEST-DELIVERY';

        $this->clientEntityManager->saveCredentials($ClientDTO);

        $this->orderEntityManager->saveOrder($orderDTO);

        $this->clientEntityManager->addToBasket('44', $this->clientRepository->getUserID($_SESSION['mail']));


        $container = new Container();
        $dependencyProvider = new DependencyProvider();
        $dependencyProvider->provide($container);
        $container->set(SearchEngine::class, new SearchEngine($this->redirectSpy));



        $this->homepageController = new HomepageController($container);
        parent::setUp(); // TODO: Change the autogenerated stub
    }

    public function testDataConstruct(): void
    {
        $_POST['search'] = '1';
        $_GET['id'] = '3';
        $_SESSION['mail'] = 'TEST@TEST.com';

        $this->homepageController->dataConstruct();


        self::assertSame('?page=shop&id=1', $this->homepageController->searchEngine->redirect->location);

        self::assertNotEmpty($this->homepageController->dataConstruct()->getParameters()['players']);
        self::assertInstanceOf(PlayerDTO::class ,$this->homepageController->dataConstruct()->getParameters()['players'][0]);
        self::assertSame('TEST@TEST.com', $this->homepageController->dataConstruct()->getParameters()['user']);
        self::assertSame('homepage.twig', $this->homepageController->dataConstruct()->getTpl());
    }

    public function tearDown(): void
    {
        $connector = new SqlConnector();
        $connector->executeDeleteQuery("DELETE FROM orders;", []);
        $connector->executeDeleteQuery("DELETE FROM user_baskets;", []);
        $connector->executeDeleteQuery("DELETE FROM users;", []);
        $connector->closeConnection();
        parent::tearDown();
    }
}
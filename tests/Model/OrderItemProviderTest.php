<?php

namespace Model;

use App\Components\Homepage\Persistence\Repository\PlayerRepository;
use App\Components\Order\Persistence\Entity\OrderEntityManager;
use App\Components\Order\Persistence\Repository\OrderRepository;
use App\Components\User\Persistence\Entity\UserEntityManager;
use App\Components\User\Persistence\Repository\UserRepository;
use App\Global\Business\DTO\ClientDTO;
use App\Global\Business\Provider\OrderItemProvider;
use App\Global\Persistence\SQL\SqlConnector;
use PHPUnit\Framework\TestCase;

class OrderItemProviderTest extends TestCase
{
    public UserEntityManager $clientEntityManager;
    public OrderRepository $orderRepository;
    public SqlConnector $sqlConnector;
    public OrderEntityManager $orderEntityManager;
    public UserRepository $clientRepository;
    public OrderItemProvider $itemProvider;

    public function setUp(): void
    {
        $this->clientRepository = new UserRepository();
        $this->sqlConnector = new SqlConnector();
        $this->clientEntityManager = new UserEntityManager();
        $this->playerRepository = new PlayerRepository();
        $this->orderRepository = new OrderRepository();
        $this->orderEntityManager = new OrderEntityManager();
        $this->itemProvider = new OrderItemProvider();

        $ClientDTO = new ClientDTO();
        $ClientDTO->username = 'TEST';
        $ClientDTO->email = 'TEST@TEST.com';
        $ClientDTO->password = '$2y$10$hfMft79lTEeHSDGsMf91s.iJcUTgVoIHnUQVGfxleSTXARmpr7nN6';

        $this->clientEntityManager->saveCredentials($ClientDTO);
        parent::setUp(); // TODO: Change the autogenerated stub
    }

    public function testGetItemsSingleQuantity(): void
    {
        $_SESSION['mail'] = 'TEST@TEST.com';

        $this->clientEntityManager->addToBasket('44', $this->clientRepository->getUserID('TEST@TEST.com'));

        $items = $this->itemProvider->getItems();

        self::assertSame([
            'id' => '44',
            'quantity' => '1',
        ], $items);
    }

    public function testGetItemsHigherQuantity(): void
    {
        $_SESSION['mail'] = 'TEST@TEST.com';

        $this->clientEntityManager->addToBasket('44', $this->clientRepository->getUserID('TEST@TEST.com'));
        $this->clientEntityManager->addToBasket('44', $this->clientRepository->getUserID('TEST@TEST.com'));
        $this->clientEntityManager->addToBasket('44', $this->clientRepository->getUserID('TEST@TEST.com'));
        $this->clientEntityManager->addToBasket('44', $this->clientRepository->getUserID('TEST@TEST.com'));



        $items = $this->itemProvider->getItems();

        self::assertSame([
            'id' => '44',
            'quantity' => '4',
        ], $items);
    }

    public function tearDown(): void
    {
        $connector = new SqlConnector();
        $connector->executeDeleteQuery("DELETE FROM orders;", []);
        $connector->executeDeleteQuery("DELETE FROM user_baskets;", []);
        $connector->executeDeleteQuery("DELETE FROM users;", []);
        $connector->closeConnection();
        parent::tearDown();
    }
}